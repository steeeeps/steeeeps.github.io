---
title: 数据库性能优化(二)—索引的使用
date: 2017-11-09 22:48:29
categories:
- 数据库
tags:
- 数据库
---


当数据库查询越来越慢，或者涉及到大数据的查询时，除了 SQL 语句优化，索引也是数据库性能优化中最常见的手段之一。

### 什么是索引

索引是对数据库中一列或者几列的数据按照特定的数据结构进行排序保存的一种方式，使用索引可以加快数据库查询 或排序时的速度。

### 索引优点

它主要有以下几点优点：

- 可以大大提高数据查询的速度。
- 在实现数据的参考完整性方面，可以加快表和表之间的连接。
- 在分组和排序时，可以减少分组和排序的时间。

### 索引缺点

但是事务都是有两面性的，索引在使用过程中也会有一定的缺陷，比如：

- 创建和维护索引需要耗费时间，数据量越大耗费时间也越长。
- 索引需要占用额外的磁盘空间，如果数据量很大又有大量索引，那么索引文件大小增加很快。
- 对表中数据改动的时候，索引需要动态维护，降低了数据操作的速度。

### 索引类型

在PostgreSQL中提供了多种索引类型： B-tree、Hash、GiST、SP-GiST 、GIN 和 BRIN。每一种索引类型使用了一种不同的算法来适应不同类型的查询。默认情况下， pg 中 CREATE INDEX命令创建的索引都属于**B-tree** 索引。

### 索引方式

在postgresql中索引有以下几种方式：

1. 多列索引：多列索引指的是一个索引可以定义在表的多个列上。这个应该是最常见的，我们根据查询的条件，在某个列上或者多个列上添加索引。

2. 排序索引：除了简单的查找需要返回的行外，还可以按照指定的顺序将数据返回，这样就使得查询中的 order by 语句不需要独立的排序步骤。这个在什么地方用到了，就是我们查询分页的时候，order by 与 limit 联合使用时，如果有一个符合 order by 的排序索引，前n行将会被直接获取且根本不需要扫描剩下的数据。如果没有这个索引的话，解析器就会扫描全表的数据进行排序，然后返回指定页数的数据。所以如果有分页的表，可以试一下这个排序索引。

3. 组合索引：前面也讲了，一般在查询条件中只有使用 AND 才能使用单一索引，而使用 or 数据库会放弃使用索引而进行全表扫描。所以Postgresql 提供了组合多个索引的能力来处理查询条件使用 and 或者 or 的查询。也包括统一查询中多次使用同一个索引的能力。

   > 比如 WHERE x = 42 OR x = 47 OR x = 53 OR x = 99 和 WHERE x = 5 AND y = 6。

4. 唯一索引：唯一索引保证表不会有超过1行的相同值的行。创建唯一索引的有利的两个原因：数据完整和性能。在唯一索引上查找通常是非常快的。这就和我们平时使用的 key value 数据库，像 redis 和 nosql 数据库类似。PostgreSQL会自动为定义了主键的表创建一个唯一索引。所以一般不需要手工的在这种表上再来创建唯一索引。

5. 表达式索引：前面也讲了尽量不要where 语句中对字段进行函数操作，那样会使数据库放弃使用索引而进行全表扫描。如果需要这样查询的话就需要提前对该表达式建立表达式索引。例如大小写不明感的查询可以这样建立索引：SELECT * FROM test1 WHERE lower(col1) = 'value';CREATE INDEXtest1_lower_col1_idx ON test1 (lower(col1));但是索引表达式维护起来很麻烦，一般建议表很少更新的时候使用，我们一般也没有用到这个索引方式。

6. 部分索引：部分索引指的是对数据表某一列部分的值进行索引。比如说我们在数据库中保存网站的访问日志。有一部分来源于我们内网自己测试的访问日志，还有一部分来源于我们真实用户的访问日志。如果我们需要通过IP搜索统计真实用户的访问情况，我们就没有必要索引对应于我们自己测试内部的IP范围。这样我们就可以建里一个部分索引。

   >  例如：CREATE INDEX access_log_client_ip_ix ON access_log (client_ip) WHERENOT (client_ip > inet '192.168.100.0' AND client_ip < inet'192.168.100.255'); 这样局域网的 ip查询就不会使用索引，这个我们也用的很少。

### 索引建立原则

1. 索引并不是越多越好，索引太多会影响insert,delete,update的性能，一般建议一张表不多于6个索引。
2. 对于经常查询的字段应该建立索引
3. 避免对经常更新的表进行过多的索引
4. 数据量很小的表最好不要使用索引，由于数据量少，扫描表的时间可能比查询索引时间要短，索引没有效果
5. 不要在不同值少的列上建立索引，例如表示性别的字段一般只有 ‘男’和‘女’两个不同值，如果建立索引会严重降低更新速度。
6. 在频繁进行排序或分组的列上建立索引时，如果待排序的列有多个，可在这些列上建立联合索引。

> 索引类型参考自：[http://www.postgres.cn/docs/9.6/indexes-types.html](http://www.postgres.cn/docs/9.6/indexes-types.html)
>
> 索引方式参考自：[http://www.postgres.cn/docs/9.6/indexes.html](http://www.postgres.cn/docs/9.6/indexes.html)
>
> 索引原则详细请参考：[http://blog.csdn.net/u013322876/article/details/52993639](http://blog.csdn.net/u013322876/article/details/52993639)